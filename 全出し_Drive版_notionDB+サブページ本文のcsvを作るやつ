import os
import requests
import json
import pandas as pd
from datetime import datetime
from google.colab import drive

# ğŸ”¹ Google Drive ã‚’ãƒã‚¦ãƒ³ãƒˆ
drive.mount('/content/drive')

# ã“ã“ã«APIã‚­ãƒ¼ã‚’ã‚»ãƒƒãƒˆï¼ˆColabã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«å…¥åŠ›ãŒå¿…è¦ï¼‰
NOTION_API_KEY = os.environ["NOTION_API_KEY"]

# ğŸ”¹ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã¨å¯¾å¿œã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®š
DATABASES = {
    "1a9c1a389044806f9825e2e713d02e62": "ã‚·ãƒ¼ãƒ³ãƒ­ã‚°",
    "1acc1a38904480d0acf1fabe9728f5fc": "è¨­å®šDB"
}

# APIãƒ˜ãƒƒãƒ€ãƒ¼
headers = {
    "Authorization": f"Bearer {os.environ['NOTION_API_KEY']}",
    "Notion-Version": "2022-06-28",
    "Content-Type": "application/json"
}

# ğŸ”¹ Google Drive ã®ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€
drive_folder = "/content/drive/MyDrive/NotionLogs"
os.makedirs(drive_folder, exist_ok=True)

# ğŸ”¹ å…¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã™ã‚‹ãƒªã‚¹ãƒˆ
all_records = []

# ğŸ”¥ å„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
for database_id, custom_name in DATABASES.items():
    print(f"ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ {database_id}ï¼ˆ{custom_name}ï¼‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­â€¦")

    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—
    url = f"https://api.notion.com/v1/databases/{database_id}/query"
    response = requests.post(url, headers=headers)
    data = response.json()

    # çµæœã‚’æ ¼ç´ã™ã‚‹ãƒªã‚¹ãƒˆ
    records = []

    # å„ãƒšãƒ¼ã‚¸ã®æƒ…å ±ã‚’å–å¾—
    for page in data["results"]:
        page_id = page["id"]
        properties = page["properties"]  # ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å–å¾—

        # **å…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¾æ›¸ã«æ ¼ç´**
        record = {"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å": custom_name}  # ã©ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚’è¨˜éŒ²

        for prop_name, prop_value in properties.items():
            if prop_value["type"] == "title":
                record[prop_name] = prop_value["title"][0]["text"]["content"] if prop_value["title"] else ""
            elif prop_value["type"] == "rich_text":
                record[prop_name] = prop_value["rich_text"][0]["text"]["content"] if prop_value["rich_text"] else ""
            elif prop_value["type"] == "select":
                record[prop_name] = prop_value["select"]["name"] if prop_value["select"] else ""
            elif prop_value["type"] == "multi_select":
                record[prop_name] = ", ".join([option["name"] for option in prop_value["multi_select"]])
            elif prop_value["type"] == "date":
                record[prop_name] = prop_value["date"]["start"] if prop_value["date"] else ""
            elif prop_value["type"] == "checkbox":
                record[prop_name] = str(prop_value["checkbox"])
            elif prop_value["type"] == "number":
                record[prop_name] = str(prop_value["number"])
            elif prop_value["type"] == "url":
                record[prop_name] = prop_value["url"] if prop_value["url"] else ""
            elif prop_value["type"] == "email":
                record[prop_name] = prop_value["email"] if prop_value["email"] else ""
            elif prop_value["type"] == "phone_number":
                record[prop_name] = prop_value["phone_number"] if prop_value["phone_number"] else ""
            else:
                record[prop_name] = "[æœªå¯¾å¿œã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£]"

        # ãƒšãƒ¼ã‚¸ã®ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆæœ¬æ–‡ï¼‰ã‚’å–å¾—
        block_url = f"https://api.notion.com/v1/blocks/{page_id}/children"
        block_response = requests.get(block_url, headers=headers)
        block_data = block_response.json()

        # æœ¬æ–‡ã‚’å–å¾—ã—ã¦çµåˆ
        content_list = []
        if "results" in block_data:
            for block in block_data["results"]:
                if block["type"] == "paragraph":
                    rich_text = block["paragraph"].get("rich_text", [])
                    if rich_text:
                        content_list.append(rich_text[0]["text"]["content"])

        record["æœ¬æ–‡"] = "\n".join(content_list) if content_list else "æœ¬æ–‡ãªã—"

        # ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
        records.append(record)
        all_records.append(record)  # ğŸ”¥ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ

    # **å€‹åˆ¥ã®CSVã«ä¿å­˜**
    df = pd.DataFrame(records)
    today_str = datetime.today().strftime("%Y%m%d")
    csv_filename = f"{today_str}_{custom_name}.csv"  # ğŸ”¹ ã‚«ã‚¹ã‚¿ãƒ åã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã«ï¼
    drive_csv_path = f"{drive_folder}/{csv_filename}"
    df.to_csv(drive_csv_path, index=False)
    print(f"âœ… {csv_filename} ã‚’ Google Drive ã«ä¿å­˜ã—ã¾ã—ãŸï¼")

# **çµ±åˆãƒ‡ãƒ¼ã‚¿ã‚’1ã¤ã®CSVã«ä¿å­˜**
df_all = pd.DataFrame(all_records)
all_csv_path = f"{drive_folder}/{today_str}_å…¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹.csv"
df_all.to_csv(all_csv_path, index=False)
print(f"âœ… ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¦ {all_csv_path} ã«ä¿å­˜ã—ã¾ã—ãŸï¼")
